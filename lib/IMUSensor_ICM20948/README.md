# IMUSensor_ICM20948

Библиотека для работы с 9-осевым IMU датчиком ICM-20948 от InvenSense.

## Особенности

- **9-осевой датчик**: 3-осевой гироскоп, 3-осевой акселерометр, 3-осевой магнитометр (AK09916)
- **DMP поддержка**: Встроенный Digital Motion Processor для обработки кватернионов
- **Автокалибровка**: Автоматическая калибровка гироскопа и магнитометра
- **Прерывания**: Поддержка прерываний для готовности данных DMP
- **Сохранение калибровки**: Автоматическое сохранение калибровочных данных в EEPROM
- **Совместимость**: Полная совместимость с интерфейсом IIMU

## Требования

- **Библиотека**: SparkFun ICM-20948 Arduino Library
- **Платформа**: ESP32, Arduino
- **Подключение**: I2C (SDA, SCL)
- **Опционально**: Пин прерывания для DMP

## Установка

1. Установите библиотеку SparkFun ICM-20948:
   ```
   Libraries Manager -> SparkFun ICM 20948 IMU
   ```

2. Скопируйте файлы `IMUSensor_ICM20948.h` и `IMUSensor_ICM20948.cpp` в ваш проект

## Подключение

### I2C подключение (стандартное):
```
ICM-20948    ESP32
VCC       -> 3.3V
GND       -> GND
SDA       -> GPIO 21 (или любой другой SDA пин)
SCL       -> GPIO 22 (или любой другой SCL пин)
INT       -> GPIO 2  (опционально, для прерываний)
```

### I2C адреса:
- `0x69` - стандартный адрес (ADR/AD0 = HIGH)
- `0x68` - альтернативный адрес (ADR/AD0 = LOW)

## Быстрый старт

```cpp
#include <Wire.h>
#include "IMUSensor_ICM20948.h"

// Создание объекта датчика
IMUSensor_ICM20948 imu("my_icm20948", ICM20948_I2C_ADDRESS, 2);

void setup() {
    Serial.begin(115200);
    Wire.begin();
    
    // Инициализация
    if (!imu.begin(100, 20)) { // 100Hz IMU, 20Hz магнитометр
        Serial.println("ICM-20948 initialization failed!");
        return;
    }
    
    // Калибровка (если нужна)
    if (!imu.isCalibrationValid()) {
        Serial.println("Starting calibration...");
        imu.calibrate();
    }
}

void loop() {
    // Чтение данных
    IMUData data = imu.readData();
    OrientationData orientation = imu.updateOrientation();
    
    // Вывод кватерниона
    Serial.printf("Q: %.3f %.3f %.3f %.3f\n", 
                  orientation.q0, orientation.q1, 
                  orientation.q2, orientation.q3);
    
    delay(10);
}
```

## API

### Основные методы

| Метод | Описание |
|-------|----------|
| `begin(imuFreq, magFreq)` | Инициализация датчика |
| `readData()` | Чтение данных IMU |
| `updateOrientation()` | Обновление ориентации |
| `calibrate()` | Полная калибровка |
| `calibrateCompass()` | Калибровка магнитометра |

### Калибровка

| Метод | Описание |
|-------|----------|
| `isCalibrationValid()` | Проверка валидности калибровки |
| `isFullyCalibrated()` | Проверка полной калибровки |
| `getCalibrationStatus()` | Статус калибровки компонентов |
| `saveCalibrationData()` | Сохранение калибровки |
| `readCalibrationData()` | Загрузка калибровки |
| `resetCalibration()` | Сброс калибровки |

### DMP и прерывания

| Метод | Описание |
|-------|----------|
| `DMPEnabled()` | Проверка включения DMP |
| `DMPValid()` | Проверка валидности DMP данных |
| `getIntStatus()` | Статус прерываний |
| `interruptPIN()` | Номер пина прерывания |

### Автокалибровка

| Метод | Описание |
|-------|----------|
| `enableAutoCalibration(enable)` | Включение автокалибровки |
| `isAutoCalibrationEnabled()` | Статус автокалибровки |

## Калибровка

### Автоматическая калибровка

ICM-20948 поддерживает автокалибровку:

1. **Гироскоп**: Автоматически калибруется при неподвижном устройстве
2. **Акселерометр**: Требует размещения в разных ориентациях
3. **Магнитометр**: Требует вращения устройства в виде восьмерки

### Ручная калибровка

```cpp
// Полная калибровка
imu.calibrate();

// Только магнитометр
imu.calibrateCompass();

// Проверка статуса
bool sys, gyro, accel, mag;
imu.getCalibrationStatus(&sys, &gyro, &accel, &mag);
```

### Сохранение калибровки

Калибровочные данные автоматически сохраняются каждые 5 минут при полной калибровке:

```cpp
// Интервал сохранения (мс)
#define ICM20948_CALIBRATION_SAVE_INTERVAL 300000 // 5 минут

// Ручное сохранение
imu.saveCalibrationData();
```

## Использование прерываний

```cpp
#define INT_PIN 2
volatile bool dataReady = false;

void IRAM_ATTR dataReadyISR() {
    dataReady = true;
}

void setup() {
    // ...инициализация...
    
    // Настройка прерывания
    pinMode(INT_PIN, INPUT);
    attachInterrupt(digitalPinToInterrupt(INT_PIN), dataReadyISR, RISING);
}

void loop() {
    if (dataReady) {
        dataReady = false;
        IMUData data = imu.readData();
        // ...обработка данных...
    }
}
```

## Структуры данных

### IMUData
```cpp
struct IMUData {
    float ax, ay, az;           // Ускорение (м/с²)
    float gx, gy, gz;           // Угловая скорость (рад/с)
    float mx, my, mz;           // Магнитное поле (калиброванное)
    int16_t mag_x, mag_y, mag_z; // Магнитное поле (сырое)
    float q0, q1, q2, q3;       // Кватернион (из DMP)
    uint32_t timestamp;         // Временная метка (мс)
};
```

### OrientationData
```cpp
struct OrientationData {
    float q0, q1, q2, q3;       // Кватернион ориентации
    uint32_t timestamp;         // Временная метка (мс)
};
```

## Примеры

Смотрите папку `examples/` для полных примеров:

- `ICM20948_Example.ino` - Базовый пример с калибровкой и прерываниями
- Интеграция с основным проектом в `src/kayak_smart.cpp`

## Сравнение с другими датчиками

| Функция | ICM-20948 | BNO055 | GY87 |
|---------|-----------|--------|------|
| DMP | ✅ | ✅ | ✅ |
| Автокалибровка | ✅ | ✅ | ⚠️ |
| Прерывания | ✅ | ❌ | ✅ |
| 9 осей | ✅ | ✅ | ✅ |
| Сохранение калибровки | ✅ | ✅ | ✅ |

## Устранение неполадок

### Датчик не найден
- Проверьте подключение I2C
- Убедитесь в правильности I2C адреса (0x69 или 0x68)
- Проверьте питание (3.3V)

### DMP не инициализируется
- Убедитесь что установлена последняя версия SparkFun библиотеки
- Попробуйте отключить и включить датчик
- Проверьте не конфликтуют ли другие I2C устройства

### Неточные данные
- Выполните калибровку в спокойной магнитной среде
- Убедитесь что устройство неподвижно во время калибровки гироскопа
- Проверьте что магнитометр калибруется вдали от металлических объектов

### Прерывания не работают
- Убедитесь что пин прерывания правильно подключен
- Проверьте что пин настроен как INPUT
- Убедитесь что используется правильный тип прерывания (RISING)

## Лицензия

Copyright (c) 2024 Ivan Rybnikov

Эта библиотека является частью проекта Smart Kayak. 