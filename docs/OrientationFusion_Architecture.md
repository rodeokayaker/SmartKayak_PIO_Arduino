# Архитектура системы Adaptive Paddle Orientation Fusion

## Общая схема

```
                    ┌─────────────────────────────────────────┐
                    │         ВХОДНЫЕ ДАННЫЕ                  │
                    │                                         │
                    │  ┌──────────────┐  ┌──────────────┐    │
                    │  │   IMU Каяка  │  │  IMU Весла   │    │
                    │  │              │  │              │    │
                    │  │ • Гироскоп   │  │ • Гироскоп   │    │
                    │  │ • Акселер.   │  │ • Акселер.   │    │
                    │  │ • Магнитом.  │  │ • Магнитом.  │    │
                    │  │ • DMP Quat   │  │ • DMP Quat   │    │
                    │  └──────────────┘  └──────────────┘    │
                    │                                         │
                    │         ┌──────────────┐                │
                    │         │ Сила лопасти │                │
                    │         └──────────────┘                │
                    └────────────────┬────────────────────────┘
                                     │
                                     ▼
                    ┌─────────────────────────────────────────┐
                    │      МОДУЛЬ ОЦЕНКИ КАЧЕСТВА ДАННЫХ      │
                    │                                         │
                    │  ┌────────────────────────────────┐    │
                    │  │  Анализ магнитометра           │    │
                    │  │  • Дисперсия (последние 10)    │    │
                    │  │  • Детектирование аномалий     │    │
                    │  │  • Валидация по паттерну       │    │
                    │  │                                │    │
                    │  │  → Качество: EXCELLENT/GOOD/   │    │
                    │  │              POOR/INVALID      │    │
                    │  └────────────────────────────────┘    │
                    └────────────────┬────────────────────────┘
                                     │
                                     ▼
        ┌────────────────────────────────────────────────────────┐
        │           МОДУЛЬ ОПРЕДЕЛЕНИЯ КОНТЕКСТА ГРЕБЛИ          │
        │                                                        │
        │  ┌──────────────────────────────────────────────┐    │
        │  │  Определение фазы гребка                     │    │
        │  │                                              │    │
        │  │  CATCH ──→ DRIVE ──→ RELEASE ──→ RECOVERY   │    │
        │  │    ↑                               │         │    │
        │  │    └───────────────────────────────┘         │    │
        │  │                                              │    │
        │  │  Критерии фаз:                              │    │
        │  │  • CATCH:    tilt < -10°, force < 400       │    │
        │  │  • DRIVE:    tilt < 0°,   force > 400       │    │
        │  │  • RELEASE:  tilt > 10°,  force < 400       │    │
        │  │  • RECOVERY: force < 400                    │    │
        │  └──────────────────────────────────────────────┘    │
        │                                                        │
        │  ┌──────────────────────────────────────────────┐    │
        │  │  Обучение паттернам (5-10 гребков)          │    │
        │  │                                              │    │
        │  │  Для левой и правой стороны:                │    │
        │  │  • Диапазон shaft rotation [min, max]       │    │
        │  │  • Диапазон shaft tilt [min, max]           │    │
        │  │  • Диапазон blade rotation [min, max]       │    │
        │  │  • Средняя длительность гребка              │    │
        │  │                                              │    │
        │  │  Обновление с экспоненциальным сглаживанием │    │
        │  └──────────────────────────────────────────────┘    │
        └────────────────────────────────────────────────────────┘
                                     │
                                     ▼
        ┌────────────────────────────────────────────────────────┐
        │            МОДУЛЬ БАЗОВОЙ ОРИЕНТАЦИИ (DMP)             │
        │                                                        │
        │  1. Загрузка DMP кватернионов                         │
        │     q_kayak, q_paddle (гироскоп + акселерометр)       │
        │                                                        │
        │  2. Проекция каяка на горизонталь                     │
        │     • Извлечение оси X каяка                          │
        │     • Проекция на плоскость XY                        │
        │     • Нормализация                                    │
        │                                                        │
        │  3. Вычисление относительной ориентации               │
        │     q_rel_base = q_kayak_horiz⁻¹ * q_paddle          │
        │                                                        │
        │  → Базовая ориентация (95-98% финального веса)       │
        └────────────────────────────────────────────────────────┘
                                     │
                                     ▼
        ┌────────────────────────────────────────────────────────┐
        │           МОДУЛЬ КОРРЕКЦИИ ДРИФТА                      │
        │                                                        │
        │  ┌──────────────────────────────────────────────┐    │
        │  │  Оценка дрифта (в фазе RECOVERY)            │    │
        │  │                                              │    │
        │  │  yaw = atan2(2(q.w*q.z + q.x*q.y),          │    │
        │  │              1 - 2(q.y² + q.z²))            │    │
        │  │                                              │    │
        │  │  drift_rate = drift_rate * 0.999 +          │    │
        │  │               (yaw/dt) * 0.001              │    │
        │  └──────────────────────────────────────────────┘    │
        │                                                        │
        │  ┌──────────────────────────────────────────────┐    │
        │  │  Применение коррекции                       │    │
        │  │                                              │    │
        │  │  angle = -drift_rate * dt * 0.01            │    │
        │  │  q_corr = [cos(angle/2), 0, 0, sin(angle/2)]│    │
        │  │  q_drift_corrected = q_corr * q_base        │    │
        │  └──────────────────────────────────────────────┘    │
        └────────────────────────────────────────────────────────┘
                                     │
                                     ▼
        ┌────────────────────────────────────────────────────────┐
        │           МОДУЛЬ МАГНИТНОЙ КОРРЕКЦИИ                   │
        │                                                        │
        │  ЕСЛИ качество = EXCELLENT или GOOD:                  │
        │                                                        │
        │  ┌──────────────────────────────────────────────┐    │
        │  │  1. Компенсация наклона (tilt compensation) │    │
        │  │     mag_horiz = q_dmp⁻¹.rotate([mx,my,mz]) │    │
        │  │                                              │    │
        │  │  2. Вычисление yaw из магнитометра          │    │
        │  │     yaw_mag = atan2(mag_horiz.y, mag_horiz.x)│   │
        │  │                                              │    │
        │  │  3. Вычисление yaw из DMP                   │    │
        │  │     yaw_dmp = atan2(...)                    │    │
        │  │                                              │    │
        │  │  4. Ошибка и коррекция                      │    │
        │  │     error = yaw_mag - yaw_dmp               │    │
        │  │     correction = error * mag_weight         │    │
        │  │     q_mag_corr = q_correction * q_dmp       │    │
        │  └──────────────────────────────────────────────┘    │
        │                                                        │
        │  ИНАЧЕ:                                               │
        │     q_mag_corr = q_drift_corrected (без изменений)   │
        └────────────────────────────────────────────────────────┘
                                     │
                                     ▼
        ┌────────────────────────────────────────────────────────┐
        │           МОДУЛЬ КОРРЕКЦИИ ПО ПАТТЕРНУ                 │
        │                                                        │
        │  ЕСЛИ паттерны обучены И фаза = DRIVE/RECOVERY:       │
        │                                                        │
        │  ┌──────────────────────────────────────────────┐    │
        │  │  1. Извлечение углов из кватерниона         │    │
        │  │     shaft_rotation, shaft_tilt, blade_rot   │    │
        │  │                                              │    │
        │  │  2. Проверка границ паттерна                │    │
        │  │     ЕСЛИ shaft_rot < pattern.min:           │    │
        │  │        correction = pattern.min - shaft_rot │    │
        │  │     ЕСЛИ shaft_rot > pattern.max:           │    │
        │  │        correction = pattern.max - shaft_rot │    │
        │  │                                              │    │
        │  │  3. Мягкая коррекция                        │    │
        │  │     angle = correction * pattern_weight     │    │
        │  │     q_pattern = q_correction * q_mag_corr   │    │
        │  └──────────────────────────────────────────────┘    │
        │                                                        │
        │  ИНАЧЕ:                                               │
        │     q_pattern = q_mag_corr (без изменений)           │
        └────────────────────────────────────────────────────────┘
                                     │
                                     ▼
        ┌────────────────────────────────────────────────────────┐
        │        КОМПЛЕМЕНТАРНЫЙ ФИЛЬТР (SLERP)                  │
        │                                                        │
        │  ┌──────────────────────────────────────────────┐    │
        │  │  Адаптивные веса в зависимости от качества  │    │
        │  │                                              │    │
        │  │  Качество Mag    │ w_dmp │ w_mag │ w_pattern│   │
        │  │  ────────────────┼───────┼───────┼──────────│   │
        │  │  EXCELLENT       │  95%  │  5%   │   0-5%   │   │
        │  │  GOOD            │  97%  │  2.5% │   5-10%  │   │
        │  │  POOR            │  98%  │  0%   │   10-15% │   │
        │  │  INVALID         │  98%  │  0%   │   15-20% │   │
        │  └──────────────────────────────────────────────┘    │
        │                                                        │
        │  ┌──────────────────────────────────────────────┐    │
        │  │  SLERP (Spherical Linear Interpolation)     │    │
        │  │                                              │    │
        │  │  q_temp = SLERP(q_drift_corr, q_mag_corr,   │    │
        │  │                 w_mag/(w_dmp + w_mag))      │    │
        │  │                                              │    │
        │  │  q_final = SLERP(q_temp, q_pattern_corr,    │    │
        │  │                  w_pattern)                 │    │
        │  │                                              │    │
        │  │  q_final = normalize(q_final)               │    │
        │  └──────────────────────────────────────────────┘    │
        └────────────────────────────────────────────────────────┘
                                     │
                                     ▼
                    ┌─────────────────────────────────────────┐
                    │         ВЫХОДНЫЕ ДАННЫЕ                 │
                    │                                         │
                    │  Точная относительная ориентация весла  │
                    │  относительно каяка:                    │
                    │                                         │
                    │  • q_relative (кватернион)              │
                    │  • shaft_rotation (угол поворота)       │
                    │  • shaft_tilt (угол наклона)            │
                    │  • blade_rotation (угол лопасти)        │
                    │                                         │
                    │  Метаданные:                            │
                    │  • Качество магнитометра                │
                    │  • Фаза гребка                          │
                    │  • Статус обучения                      │
                    │  • Скорость дрифта                      │
                    └─────────────────────────────────────────┘
```

## Поток данных в реальном времени

```
Время →

t₀: IMU данные поступают (100 Гц)
    │
    ▼
t₁: Обновление буфера магнитометра [10 последних измерений]
    │
    ▼
t₂: Оценка качества:
    - Расчет дисперсии: var = Σ(x - mean)² / (n-1)
    - Детектирование аномалий: 100 < |mag| < 1000
    - Классификация: EXCELLENT/GOOD/POOR/INVALID
    │
    ▼
t₃: Определение фазы гребка:
    - Анализ tilt angle и blade force
    - CATCH → DRIVE → RELEASE → RECOVERY
    │
    ▼
t₄: Обучение (если CATCH):
    - Обновление диапазонов углов
    - Экспоненциальное сглаживание α=0.1
    - После 5 гребков → паттерны готовы
    │
    ▼
t₅: Вычисление базовой ориентации:
    - DMP кватернионы (гироскоп + акселерометр)
    - Проекция на горизонталь
    - q_rel = q_kayak_horiz⁻¹ * q_paddle
    │
    ▼
t₆: Коррекция дрифта (в фазе RECOVERY):
    - Оценка скорости дрифта
    - Малая компенсация по yaw
    │
    ▼
t₇: Магнитная коррекция (если EXCELLENT/GOOD):
    - Tilt compensation
    - Вычисление yaw из магнитометра
    - Коррекция с весом 2-5%
    │
    ▼
t₈: Коррекция по паттерну (если обучены):
    - Проверка границ
    - Мягкая коррекция к границам
    │
    ▼
t₉: Комплементарный фильтр (SLERP):
    - Адаптивные веса
    - Сферическая интерполяция
    - Нормализация
    │
    ▼
t₁₀: Выход - точная относительная ориентация
     Используется в SmartKayak::update() для:
     - Расчета углов весла
     - Определения активной лопасти
     - Вычисления эффективной силы
```

## Пример числовых значений

### Входные данные (t=0)
```
Каяк IMU:
  - Гироскоп: [2.1, -0.3, 0.8] рад/с
  - Акселерометр: [0.1, -0.2, 9.8] м/с²
  - Магнитометр: [245, -312, 428] (сырые)
  - DMP Quat: [0.98, 0.05, -0.12, 0.08]

Весло IMU:
  - Гироскоп: [1.8, 0.5, -0.2] рад/с
  - Акселерометр: [-2.1, 3.4, 8.9] м/с²
  - Магнитометр: [198, -278, 391] (сырые)
  - DMP Quat: [0.92, 0.15, -0.28, 0.18]

Сила лопасти: 850 грамм
```

### Оценка качества (t=2)
```
Дисперсия магнитометра (каяк):
  var_x = 145, var_y = 178, var_z = 132
  total_var = 455 < 500 (порог) → ХОРОШО

Дисперсия магнитометра (весло):
  var_x = 123, var_y = 156, var_z = 108
  total_var = 387 < 500 (порог) → ХОРОШО

Итого: MagnetometerQuality::GOOD
```

### Определение фазы (t=3)
```
shaft_tilt = -8.5° (< 0°)
blade_force = 850 (> 400)

→ StrokePhase::DRIVE (гребок)
```

### Базовая ориентация (t=5)
```
q_kayak = [0.98, 0.05, -0.12, 0.08]
q_paddle = [0.92, 0.15, -0.28, 0.18]

Проекция каяка:
  x_k = [0.87, 0.21, -0.15]
  x_horiz = [0.97, 0.23, 0] (нормализовано)

q_kayak_horiz = [0.99, 0, 0, 0.12]
q_rel_base = q_kayak_horiz⁻¹ * q_paddle
           = [0.94, 0.13, -0.25, 0.15]
```

### Коррекция дрифта (t=6)
```
drift_rate = 0.003 рад/с (текущая оценка)
dt = 0.01 с
drift_angle = -0.003 * 0.01 * 0.01 = -0.0003 рад

q_drift_corr = [0.999999, 0, 0, -0.00015]
q_corrected = q_drift_corr * q_rel_base
            = [0.94, 0.13, -0.25, 0.15] (малое изменение)
```

### Магнитная коррекция (t=7, качество GOOD)
```
mag_weight = 0.025 (2.5% для GOOD)

yaw_mag = atan2(-278, 198) = -0.95 рад (-54.5°)
yaw_dmp = atan2(2*(0.94*0.15 + 0.13*(-0.25)), ...) = -0.97 рад (-55.6°)

error = -0.95 - (-0.97) = 0.02 рад (1.1°)
correction = 0.02 * 0.025 = 0.0005 рад

q_mag_corr = [0.999999, 0, 0, 0.00025] * q_corrected
           = [0.94, 0.13, -0.25, 0.15] (коррекция 0.03°)
```

### Финальный фильтр (t=9)
```
Веса (для GOOD качества):
  w_dmp = 0.97
  w_mag = 0.025  
  w_pattern = 0.005 (паттерны обучены)

Нормализация:
  total = 1.0
  w_dmp = 0.970
  w_mag = 0.025
  w_pattern = 0.005

SLERP:
  q_temp = SLERP(q_drift_corr, q_mag_corr, 0.025/0.995)
  q_final = SLERP(q_temp, q_pattern_corr, 0.005)
  
→ q_relative = [0.94, 0.13, -0.25, 0.15]
```

### Выходные углы (t=10)
```
shaft_rotation = 32.5°
shaft_tilt = -8.5°
blade_rotation = -45.2°

→ Используется в SmartKayak для расчета моторной силы
```

## Ключевые преимущества архитектуры

1. **Модульность** - каждый модуль независим и тестируем
2. **Адаптивность** - автоматическая подстройка весов
3. **Graceful degradation** - работа при отказе любого датчика
4. **Контекстная осведомленность** - использование знаний о гребле
5. **Численная стабильность** - нормализация на каждом шаге
