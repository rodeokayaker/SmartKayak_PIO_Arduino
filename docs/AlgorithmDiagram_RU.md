# Визуальная схема алгоритма фильтрации

## 🔄 Полный цикл обработки данных

```
┌────────────────────────────────────────────────────────────────┐
│                      ВХОДНЫЕ ДАННЫЕ                            │
└────────────────────────────────────────────────────────────────┘
                                │
                ┌───────────────┴──────────────┐
                │                              │
                ▼                              ▼
┌───────────────────────────┐    ┌───────────────────────────┐
│    IMU КАЯКА              │    │    IMU ВЕСЛА              │
│                           │    │                           │
│  • DMP Quaternion (q)     │    │  • DMP Quaternion (q)     │
│  • Магнитометр (mx,my,mz) │    │  • Магнитометр (mx,my,mz) │
│  • Гироскоп (gx,gy,gz)    │    │  • Гироскоп (gx,gy,gz)    │
│  • Акселерометр (ax,ay,az)│    │  • Акселерометр (ax,ay,az)│
└───────────────────────────┘    └───────────────────────────┘
                │                              │
                └───────────────┬──────────────┘
                                │
                                ▼
┌────────────────────────────────────────────────────────────────┐
│              ДЕТЕКТОР МАГНИТНЫХ ПОМЕХ                          │
│                                                                │
│  Для каждого магнитометра:                                     │
│                                                                │
│  1. Сохраняем историю (20 измерений)                           │
│     [m₀, m₁, m₂, ... m₁₉]                                      │
│                                                                │
│  2. Вычисляем дисперсию:                                       │
│     σ² = (1/N)Σ(mᵢ - μ)²                                       │
│                                                                │
│  3. Проверяем изменение магнитуды:                             │
│     Δ|m| = ||m_current| - |m_avg|| / |m_avg|                   │
│                                                                │
│  4. Вычисляем уровень доверия:                                 │
│     Trust = f(σ², Δ|m|)  ∈ [0.0, 1.0]                          │
│                                                                │
│     • σ² > 800    → Trust уменьшается                          │
│     • Δ|m| > 20%  → Trust уменьшается                          │
│                                                                │
└────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌────────────────────────────────────────────────────────────────┐
│           КОРРЕКЦИЯ YAW МАГНИТОМЕТРОМ (если Trust > 0.3)       │
│                                                                │
│  Если Trust_mag > 0.3:                                         │
│                                                                │
│    1. m_body = Q_DMP⁻¹ ⊗ m_world ⊗ Q_DMP                       │
│                                                                │
│    2. m_h = (m_body.x, m_body.y, 0)  # проекция на XY          │
│                                                                │
│    3. yaw_mag = atan2(m_h.y, m_h.x)                            │
│                                                                │
│    4. yaw_corrected = yaw_DMP + Δyaw * Trust * 0.02            │
│                                                                │
│    5. Q_mag_corrected = fromEuler(roll_DMP, pitch_DMP, yaw_cor)│
│                                                                │
│  Иначе:                                                        │
│    Q_mag_corrected = Q_DMP  # игнорируем магнитометр           │
│                                                                │
└────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌────────────────────────────────────────────────────────────────┐
│               КОМПЛЕМЕНТАРНЫЙ ФИЛЬТР                           │
│                                                                │
│  Адаптивное объединение DMP и магнитометра:                    │
│                                                                │
│  weight_gyro = 0.98 + (1 - Trust) * 0.02                       │
│  weight_mag = 1 - weight_gyro                                  │
│                                                                │
│  Q_filtered = SLERP(Q_DMP, Q_mag_corrected, weight_mag)        │
│                                                                │
│  SLERP - сферическая интерполяция кватернионов:                │
│                                                                │
│    θ = arccos(Q₁ · Q₂)                                         │
│                                                                │
│    Q = [sin((1-t)θ)/sin(θ)] * Q₁ + [sin(tθ)/sin(θ)] * Q₂       │
│                                                                │
└────────────────────────────────────────────────────────────────┘
                                │
                ┌───────────────┴──────────────┐
                │                              │
                ▼                              ▼
        Q_kayak_filtered            Q_paddle_filtered
                │                              │
                └───────────────┬──────────────┘
                                │
                                ▼
┌────────────────────────────────────────────────────────────────┐
│          ВЫЧИСЛЕНИЕ ОТНОСИТЕЛЬНОЙ ОРИЕНТАЦИИ                   │
│                                                                │
│  1. Извлекаем направление каяка:                               │
│     x_k = Q_kayak ⊗ (1,0,0) ⊗ Q_kayak⁻¹                        │
│                                                                │
│  2. Проецируем на горизонталь (убираем наклон):                │
│     x_h = (x_k.x, x_k.y, 0)                                    │
│     x_h = x_h / |x_h|                                          │
│                                                                │
│  3. Строим кватернион "горизонтального каяка":                 │
│     Q_h = quaternion_from_direction(x_h)                       │
│                                                                │
│  4. Относительная ориентация:                                  │
│     Q_relative = Q_h⁻¹ ⊗ Q_paddle                              │
│                                                                │
└────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌────────────────────────────────────────────────────────────────┐
│          КОРРЕКЦИЯ НА ОСНОВЕ ПАТТЕРНОВ ГРЕБЛИ                  │
│                                                                │
│  Начало гребка:                                                │
│    1. Определяем: strokeActive, bladeSide, shaftRotation       │
│    2. Ищем похожий паттерн из истории (10 паттернов)           │
│    3. similarity = f(shaft_angle_diff) * confidence            │
│    4. Выбираем best_pattern если similarity > 0.6              │
│                                                                │
│  Во время гребка (если есть pattern):                          │
│    1. progress = elapsed_time / pattern.duration               │
│    2. expected_yaw = start_yaw + pattern.Δyaw * progress       │
│    3. correction = (expected_yaw - current_yaw) * 0.1          │
│    4. Q_relative_corrected = apply_yaw_correction(correction)  │
│                                                                │
│  Конец гребка:                                                 │
│    1. Сохраняем новый паттерн:                                 │
│       • Δyaw за гребок                                         │
│       • Начальный/конечный угол шафта                          │
│       • Длительность                                           │
│       • Confidence (средний Trust магнитометров)               │
│    2. Обновляем память паттернов (max 10)                      │
│                                                                │
└────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌────────────────────────────────────────────────────────────────┐
│                  ВЫХОДНЫЕ ДАННЫЕ                               │
│                                                                │
│  Q_relative_final - точная относительная ориентация весла      │
│                                                                │
│  Из нее вычисляются углы:                                      │
│    • shaftRotationAngle  - поворот шафта в плоскости каяка     │
│    • shaftTiltAngle      - наклон шафта                        │
│    • bladeRotationAngle  - угол лопасти                        │
│                                                                │
│  Статистика:                                                   │
│    • Trust_kayak_mag, Trust_paddle_mag                         │
│    • interference_count, correction_count                      │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

## 📊 Диаграмма принятия решений

```
                    Получены данные IMU
                            │
                            ▼
                ┌──────────────────────┐
                │  Анализ магнитометра │
                └──────────────────────┘
                            │
            ┌───────────────┴──────────────┐
            │                              │
            ▼                              ▼
    ┌──────────────┐              ┌──────────────┐
    │ Низкая       │              │ Высокая      │
    │ дисперсия    │              │ дисперсия    │
    │ σ² < 800     │              │ σ² > 800     │
    └──────────────┘              └──────────────┘
            │                              │
            ▼                              ▼
    ┌──────────────┐              ┌──────────────┐
    │ Нет резких   │              │ Резкие       │
    │ изменений    │              │ изменения    │
    │ Δ|m| < 20%   │              │ Δ|m| > 20%   │
    └──────────────┘              └──────────────┘
            │                              │
            ▼                              ▼
    ┌──────────────┐              ┌──────────────┐
    │ Trust = 0.8+ │              │ Trust = 0.1- │
    │              │              │              │
    │ Используем   │              │ Игнорируем   │
    │ магнитометр  │              │ магнитометр  │
    └──────────────┘              └──────────────┘
            │                              │
            ▼                              ▼
    Коррекция yaw                  Только DMP
    (2% в секунду)                 (без коррекции)
            │                              │
            └───────────────┬──────────────┘
                            ▼
                    Комплементарный фильтр
                    (SLERP интерполяция)
                            │
                            ▼
                    Относительная ориентация
                            │
            ┌───────────────┴──────────────┐
            │                              │
            ▼                              ▼
    ┌──────────────┐              ┌──────────────┐
    │ Гребок       │              │ Нет гребка   │
    │ активен      │              │              │
    └──────────────┘              └──────────────┘
            │                              │
            ▼                              │
    Есть подходящий                        │
    паттерн?                               │
            │                              │
    ┌───────┴─────────┐                    │
    │                 │                    │
    ▼                 ▼                    │
  ДА               НЕТ                     │
    │                 │                    │
    ▼                 ▼                    │
Применяем      Записываем                 │
коррекцию      новый паттерн               │
(10% силы)                                 │
    │                 │                    │
    └────────┬────────┘                    │
             │                             │
             └──────────────┬──────────────┘
                            ▼
                    Финальная ориентация
```

## 🎯 Граф состояний системы

```
                          ИНИЦИАЛИЗАЦИЯ
                                │
                                ▼
                          ┌──────────┐
                          │  СТАРТ   │
                          └──────────┘
                                │
                        delay(3s) - стабилизация
                                │
                                ▼
                          ┌──────────────┐
                          │  КАЛИБРОВКА  │
                          │  магнитометра│
                          └──────────────┘
                                │
                    Сохранение референса
                                │
                                ▼
                    ┌───────────────────────┐
                    │   РАБОЧИЙ РЕЖИМ       │
                    │                       │
                    │  Цикл 100 Hz:         │
                    │  ┌─────────────────┐  │
                    │  │ Детекция помех  │  │
                    │  └────────┬────────┘  │
                    │           │           │
                    │           ▼           │
                    │  ┌─────────────────┐  │
                    │  │ Фильтрация      │  │
                    │  └────────┬────────┘  │
                    │           │           │
                    │           ▼           │
                    │  ┌─────────────────┐  │
                    │  │ Относительная   │  │
                    │  │ ориентация      │  │
                    │  └────────┬────────┘  │
                    │           │           │
                    │           ▼           │
                    │  ┌─────────────────┐  │
                    │  │ Паттерн-        │  │
                    │  │ коррекция       │  │
                    │  └─────────────────┘  │
                    └───────────────────────┘
                                │
                    ┌───────────┴────────────┐
                    │                        │
        Trust < 0.3 для обоих         Trust > 0.9
        на протяжении 30s              стабильно 5s
                    │                        │
                    ▼                        ▼
            ┌──────────────┐         ┌──────────────┐
            │  ПРЕДУПР.    │         │  АВТО-       │
            │  О ПОМЕХАХ   │         │  КАЛИБРОВКА  │
            └──────────────┘         └──────────────┘
                    │                        │
            Ждем улучшения            Обновление
            или ручную                референса
            рекалибровку                     │
                    │                        │
                    └───────────┬────────────┘
                                │
                                ▼
                          РАБОЧИЙ РЕЖИМ
                         (продолжение)
```

## 🔬 Временная диаграмма

```
Время →

DMP Кватернионы:    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                    (Всегда активны)

Магнитометр:        ▓▓▓▓▓░░░░▓▓▓▓▓▓▓▓░░░░░▓▓▓▓▓▓
                    ▲    ▲       ▲          ▲
                    │    │       │          │
                  Trust  │     Trust      Trust
                  = 0.9  │     = 0.8      = 0.2
                         │                (помехи)
                    Помеха
                    обнаружена

Коррекция yaw:      ████  ░░  ████████  ░░░  ███
                    ▲          ▲              ▲
                    │          │              │
                  Активна   Активна       Неактивна
                  (2%/s)    (1.6%/s)      (помехи)

Паттерны гребли:    ░░░░██████░░░░░░██████░░░░░░
                        ▲            ▲
                        │            │
                    Гребок 1     Гребок 2
                    (коррекция   (использует
                     записана)    паттерн №1)

Финальная точность: ████████████████████████████
                    ▲        ▲           ▲
                    │        │           │
                  ±0.5°    ±0.3°       ±2.0°
                  (норма)  (отлично)   (помехи,
                                        но стабильно)

Легенда:
█ - Высокая точность/активность
▓ - Средняя точность/активность  
░ - Низкая точность/неактивность
```

## 💡 Ключевые моменты

### Приоритеты источников данных:

1. **DMP кватернионы** (всегда) - база ориентации
2. **Магнитометр** (если Trust > 0.3) - коррекция дрифта
3. **Паттерны гребли** (во время гребка) - траекторная коррекция

### Адаптация к условиям:

| Условия | DMP | Магнитометр | Паттерны | Результат |
|---------|-----|-------------|----------|-----------|
| Идеальные | 98% | 2% (полная) | Активно | ±0.3° |
| Легкие помехи | 99% | 1% (частичная) | Активно | ±0.5° |
| Сильные помехи | 100% | 0% (выкл) | Активно | ±1.5° |
| Без гребка | 98% | 2% (если нет помех) | Неактивно | ±0.5° |

### Самообучение:

```
Гребок 1: Запись паттерна
         ↓
Гребок 2: Использование паттерна 1
         Запись паттерна 2
         ↓
Гребок 3: Выбор похожего (1 или 2)
         Коррекция на основе паттерна
         Запись нового паттерна
         ↓
...      Улучшение с каждым гребком
```

---

Эта схема показывает полный путь данных от сырых измерений IMU до точной относительной ориентации весла!
