# üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç: –¢–æ—á–Ω–∞—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –≤–µ—Å–ª–∞

## üì¶ –ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –ø—Ä–æ–µ–∫—Ç

```
lib/SmartKayak/
‚îú‚îÄ‚îÄ RelativeOrientationFilter.h       ‚Üê –ó–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–π —Ñ–∞–π–ª —Ñ–∏–ª—å—Ç—Ä–∞
‚îú‚îÄ‚îÄ RelativeOrientationFilter.cpp     ‚Üê –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞
‚îú‚îÄ‚îÄ SmartKayak.h                      ‚Üê –û–±–Ω–æ–≤–ª–µ–Ω (–¥–æ–±–∞–≤–ª–µ–Ω —Ñ–∏–ª—å—Ç—Ä)
‚îî‚îÄ‚îÄ SmartKayak.cpp                    ‚Üê –û–±–Ω–æ–≤–ª–µ–Ω (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞)

docs/
‚îú‚îÄ‚îÄ RelativeOrientationFilter_README.md     ‚Üê –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îî‚îÄ‚îÄ AlgorithmExplanation_RU.md             ‚Üê –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º–∞

examples/
‚îî‚îÄ‚îÄ SmartKayak_FilterIntegration_Example.cpp  ‚Üê –ü—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

tests/
‚îî‚îÄ‚îÄ RelativeOrientationFilter_Tests.cpp       ‚Üê –¢–µ—Å—Ç—ã –∏ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞
```

## ‚ö° –ë—ã—Å—Ç—Ä–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (5 –º–∏–Ω—É—Ç)

### –®–∞–≥ 1: –ö–æ–º–ø–∏–ª—è—Ü–∏—è

–§–∏–ª—å—Ç—Ä —É–∂–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω! –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç:

```bash
pio run
```

### –®–∞–≥ 2: –ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

–í –≤–∞—à–µ–º `setup()` –¥–æ–±–∞–≤—å—Ç–µ:

```cpp
void setup() {
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ...
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
    FilterParameters params;
    params.nominalMagMagnitude = 50.0f;  // –î–ª—è —Å—Ä–µ–¥–Ω–∏—Ö —à–∏—Ä–æ—Ç
    params.magTolerancePercent = 30.0f;
    kayak.getOrientationFilter().setParameters(params);
}
```

### –®–∞–≥ 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

–§–∏–ª—å—Ç—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ `kayak.update()`! –î–∞–Ω–Ω—ã–µ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è.

## üîß –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –¥–ª—è –≤–∞—à–µ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

### –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –º–∞–≥–Ω–∏—Ç–Ω–æ–µ –ø–æ–ª–µ –ó–µ–º–ª–∏

**–°–ø–æ—Å–æ–± 1**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞

```cpp
#include "RelativeOrientationFilter_Tests.cpp"

void setup() {
    // ... –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ...
    
    // –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
    float nominalMag = calibrate_nominal_magnetic_field(kayak.imu, 100);
    
    FilterParameters params;
    params.nominalMagMagnitude = nominalMag;
    kayak.getOrientationFilter().setParameters(params);
}
```

**–°–ø–æ—Å–æ–± 2**: –û–Ω–ª–∞–π–Ω –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä

1. –û—Ç–∫—Ä–æ–π—Ç–µ https://www.ngdc.noaa.gov/geomag/calculators/magcalc.shtml
2. –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
3. –í–æ–∑—å–º–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ "Total Field" –≤ –Ω–∞–Ω–æ—Ç–µ—Å–ª–∞—Ö
4. –ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ –≤ –º–∏–∫—Ä–æ—Ç–µ—Å–ª—ã (—Ä–∞–∑–¥–µ–ª–∏—Ç–µ –Ω–∞ 1000)

```cpp
params.nominalMagMagnitude = 48.5f;  // –ü—Ä–∏–º–µ—Ä –¥–ª—è –ú–æ—Å–∫–≤—ã
```

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### –í—ã–≤–æ–¥ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

```cpp
void loop() {
    kayak.update();
    
    // –ö–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
    static unsigned long lastLog = 0;
    if (millis() - lastLog > 1000) {
        lastLog = millis();
        
        Serial.printf("Mag: K=%s P=%s | Phase: %d | Drift: %.1f¬∞\n",
            kayak.isKayakMagnetometerReliable() ? "‚úì" : "‚úó",
            kayak.isPaddleMagnetometerReliable() ? "‚úì" : "‚úó",
            (int)kayak.getCurrentStrokePhase(),
            kayak.getOrientationFilter().getYawDriftCorrection() * RAD_TO_DEG
        );
    }
}
```

### –û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥

```
Mag: K=‚úì P=‚úì | Phase: 2 | Drift: 0.3¬∞   ‚Üê –•–æ—Ä–æ—à–æ!
Mag: K=‚úó P=‚úì | Phase: 1 | Drift: 0.5¬∞   ‚Üê –ü–æ–º–µ—Ö–∞ –Ω–∞ –∫–∞—è–∫–µ
Mag: K=‚úì P=‚úì | Phase: 0 | Drift: 0.2¬∞   ‚Üê –û—Ç–ª–∏—á–Ω–æ!
```

## üéØ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥ —É—Å–ª–æ–≤–∏—è

### –ß–∏—Å—Ç–∞—è –≤–æ–¥–∞ (–º–æ—Ä–µ, –æ–∑–µ—Ä–æ)

```cpp
FilterParameters params;
params.gyroTrust = 0.96f;              // –ù–µ–º–Ω–æ–≥–æ –±–æ–ª—å—à–µ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏
params.magTrustMax = 0.04f;            // –ë–æ–ª—å—à–µ –¥–æ–≤–µ—Ä–∏—è –º–∞–≥–Ω–∏—Ç–æ–º–µ—Ç—Ä—É
params.strokePhaseWeight = 0.05f;      // –ú–µ–Ω—å—à–µ –≤–ª–∏—è–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
kayak.getOrientationFilter().setParameters(params);
```

**–ü—Ä–∏–∑–Ω–∞–∫–∏**: –û–±–∞ –º–∞–≥–Ω–∏—Ç–æ–º–µ—Ç—Ä–∞ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç ‚úì –ø–æ—Å—Ç–æ—è–Ω–Ω–æ

### –ì–æ—Ä–æ–¥—Å–∫–∏–µ —É—Å–ª–æ–≤–∏—è (–º–æ—Å—Ç—ã, –º–µ—Ç–∞–ª–ª)

```cpp
FilterParameters params;
params.gyroTrust = 0.99f;              // –ú–∞–∫—Å–∏–º—É–º –¥–æ–≤–µ—Ä–∏—è DMP
params.magTrustMax = 0.0f;             // –û–¢–ö–õ–Æ–ß–ò–¢–¨ –º–∞–≥–Ω–∏—Ç–æ–º–µ—Ç—Ä
params.strokePhaseWeight = 0.15f;      // –ë–æ–ª—å—à–µ –≤–ª–∏—è–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
kayak.getOrientationFilter().setParameters(params);
```

**–ü—Ä–∏–∑–Ω–∞–∫–∏**: –ß–∞—Å—Ç—ã–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è ‚úó/‚úì –≤ —Å—Ç–∞—Ç—É—Å–µ –º–∞–≥–Ω–∏—Ç–æ–º–µ—Ç—Ä–æ–≤

### –°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è (—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å)

```cpp
FilterParameters params;
params.gyroTrust = 0.985f;
params.magTrustMax = 0.015f;
params.strokePhaseWeight = 0.10f;
kayak.getOrientationFilter().setParameters(params);
```

**–¶–µ–ª—å**: –ú–∏–Ω–∏–º—É–º –¥—Ä–æ–∂–∞–Ω–∏—è, –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–∞—è —Ä–∞–±–æ—Ç–∞

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ú–∞–≥–Ω–∏—Ç–æ–º–µ—Ç—Ä –≤—Å–µ–≥–¥–∞ "–Ω–µ–Ω–∞–¥–µ–∂–µ–Ω"

**–ü—Ä–∏—á–∏–Ω—ã**:
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ `nominalMagMagnitude`
- –°–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–∏–π `magTolerancePercent`

**–†–µ—à–µ–Ω–∏–µ**:
```cpp
// –£–≤–µ–ª–∏—á–∏—Ç—å –¥–æ–ø—É—Å–∫
params.magTolerancePercent = 40.0f;  // –ë—ã–ª–æ 30%

// –ò–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å —Å–æ–≤—Å–µ–º
params.magTrustMax = 0.0f;
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –ë–æ–ª—å—à–æ–π –¥—Ä–∏—Ñ—Ç (> 3¬∞/–º–∏–Ω)

**–ü—Ä–∏—á–∏–Ω—ã**:
- IMU –Ω–µ –æ—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω
- –ú–∞–≥–Ω–∏—Ç–æ–º–µ—Ç—Ä –æ—Ç–∫–ª—é—á–µ–Ω –∏–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–†–µ—à–µ–Ω–∏–µ**:
1. –û—Ç–∫–∞–ª–∏–±—Ä—É–π—Ç–µ IMU (–ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –¥–∞—Ç—á–∏–∫–∞)
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–∞–≥–Ω–∏—Ç–æ–º–µ—Ç—Ä:
```cpp
IMUData data;
kayak.imu->getData(data);
Serial.printf("Mag: %d %d %d\n", data.mag_x, data.mag_y, data.mag_z);
// –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–µ–Ω—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
```

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –§–∞–∑—ã –≥—Ä–µ–±–∫–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω—ã**:
- –¢–µ–Ω–∑–æ–¥–∞—Ç—á–∏–∫–∏ –Ω–µ –æ—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω—ã
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ñ–∞–∑

**–†–µ—à–µ–Ω–∏–µ**:
–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:
```cpp
Serial.printf("ShaftTilt: %.1f | Force: %.0f\n", shaftTiltAngle, bladeForce);
```

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ—Ä–æ–≥–∏ –≤ `RelativeOrientationFilter.cpp`:
```cpp
// –í –º–µ—Ç–æ–¥–µ detectStrokePhase()
if (shaftTilt < -15.0f && abs(bladeForce) > 200) {  // –ë—ã–ª–æ -20 –∏ 300
    return StrokePhase::CATCH;
}
```

## üìà –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –¢–µ–∫—É—â–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞

- **CPU**: ~2% @ 240MHz (ESP32)
- **RAM**: < 1 KB
- **–ß–∞—Å—Ç–æ—Ç–∞**: 50-100 Hz (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Å IMU)

### –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–Ω–∏–∑–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É

```cpp
// –í—ã–∑—ã–≤–∞—Ç—å —Ä–µ–∂–µ
if (loopCounter % 2 == 0) {  // –ö–∞–∂–¥—ã–π –≤—Ç–æ—Ä–æ–π —Ü–∏–∫–ª
    paddleRelativeQuat = orientationFilter.update(...);
}
```

### –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–≤—ã—Å–∏—Ç—å –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç—å

```cpp
// –°–Ω–∏–∑–∏—Ç—å —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ
params.gyroTrust = 0.95f;  // –ë—ã–ª–æ 0.98f - –±—ã—Å—Ç—Ä–µ–µ —Ä–µ–∞–∫—Ü–∏—è
```

## üß™ –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Å–µ —Ç–µ—Å—Ç—ã:

```cpp
#include "RelativeOrientationFilter_Tests.cpp"

void setup() {
    // ... –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ...
    
    runAllFilterTests(&kayak);
    
    // –¢–µ—Å—Ç—ã –∑–∞–π–º—É—Ç ~10 –º–∏–Ω—É—Ç
    // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ Serial Monitor
}
```

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

- **–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: `docs/RelativeOrientationFilter_README.md`
- **–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º–∞**: `docs/AlgorithmExplanation_RU.md`
- **–ü—Ä–∏–º–µ—Ä—ã**: `examples/SmartKayak_FilterIntegration_Example.cpp`
- **–¢–µ—Å—Ç—ã**: `tests/RelativeOrientationFilter_Tests.cpp`

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –∑–∞–ø—É—Å–∫–∞

- [ ] –ü—Ä–æ–µ–∫—Ç —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] –í—ã–ø–æ–ª–Ω–µ–Ω–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ –º–∞–≥–Ω–∏—Ç–Ω–æ–≥–æ –ø–æ–ª—è
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥ —É—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (–º–∞–≥–Ω–∏—Ç–æ–º–µ—Ç—Ä—ã, —Ñ–∞–∑—ã)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω —Ä–µ–∞–ª—å–Ω—ã–π –≥—Ä–µ–±–æ–∫
- [ ] –ò–∑–º–µ—Ä–µ–Ω –¥—Ä–∏—Ñ—Ç (< 3¬∞/–º–∏–Ω - —Ö–æ—Ä–æ—à–æ)

## üéâ –ì–æ—Ç–æ–≤–æ!

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç DMP –∫–≤–∞—Ç–µ—Ä–Ω–∏–æ–Ω—ã –∫–∞–∫ –æ—Å–Ω–æ–≤—É (98%)
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç –¥—Ä–∏—Ñ—Ç –º–∞–≥–Ω–∏—Ç–æ–º–µ—Ç—Ä–æ–º (–∫–æ–≥–¥–∞ –Ω–∞–¥–µ–∂–µ–Ω)
- ‚úÖ –£—á–∏—Ç—ã–≤–∞–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≥—Ä–µ–±–ª–∏
- ‚úÖ –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –º–∞–≥–Ω–∏—Ç–Ω—ã–µ –ø–æ–º–µ—Ö–∏
- ‚úÖ –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ç–æ—á–Ω–æ—Å—Ç—å < 3¬∞ –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö

---

**–í–æ–ø—Ä–æ—Å—ã?** –°–º–æ—Ç—Ä–∏—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –≤ `docs/`

**–ü—Ä–æ–±–ª–µ–º—ã?** –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã –∏–∑ `tests/RelativeOrientationFilter_Tests.cpp`
